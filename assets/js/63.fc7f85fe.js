(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{338:function(t,e,s){"use strict";s.r(e);var a=s(13),r=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"开启-modsecurity"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开启-modsecurity"}},[t._v("#")]),t._v(" 开启 ModSecurity "),e("Badge",{attrs:{text:"仅限最新的 Current 版本",type:"tip"}})],1),t._v(" "),e("p",[t._v("本项目提供的默认规则十分容易被绕过，而且许多用户并没有足够的能力和时间去维护一套可靠的规则。")]),t._v(" "),e("p",[t._v("这种情况下你可以选择启用 "),e("a",{attrs:{href:"https://github.com/SpiderLabs/ModSecurity",target:"_blank",rel:"noopener noreferrer"}},[t._v("ModSecurity"),e("OutboundLink")],1),t._v(" 并启用 "),e("a",{attrs:{href:"https://owasp.org/www-project-modsecurity-core-rule-set/",target:"_blank",rel:"noopener noreferrer"}},[t._v("OWSAP(Open Web Application Security Project) 核心规则集"),e("OutboundLink")],1),t._v(" 来增强防护能力。")]),t._v(" "),e("h2",{attrs:{id:"第一步-下载规则集"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第一步-下载规则集"}},[t._v("#")]),t._v(" 第一步：下载规则集")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /usr/local/src\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/SpiderLabs/ModSecurity.git\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/coreruleset/coreruleset.git\n")])])]),e("h2",{attrs:{id:"第二步-拷贝规则文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第二步-拷贝规则文件"}},[t._v("#")]),t._v(" 第二步：拷贝规则文件")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /etc/nginx/rules/modsecurity\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" coreruleset/crs-setup.conf.example /etc/nginx/rules/modsecurity/crs-setup.conf\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" ModSecurity/modsecurity.conf-recommended /etc/nginx/rules/modsecurity/modsecurity.conf\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" ModSecurity/unicode.mapping /etc/nginx/rules/modsecurity/unicode.mapping\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -r coreruleset/rules /etc/nginx/rules/modsecurity/owasp\n")])])]),e("h2",{attrs:{id:"第三步-修改规则文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第三步-修改规则文件"}},[t._v("#")]),t._v(" 第三步：修改规则文件")]),t._v(" "),e("ol",[e("li",[t._v("编辑 "),e("code",[t._v("/etc/nginx/rules/modsecurity/modsecurity.conf")]),t._v("，将 "),e("code",[t._v("SecRuleEngine DetectionOnly")]),t._v(" 修改为 "),e("code",[t._v("SecRuleEngine on")]),t._v("。")]),t._v(" "),e("li",[t._v("编辑 "),e("code",[t._v("/etc/nginx/rules/modsecurity/modsecurity.conf")]),t._v("，在文件末尾追加下列内容。"),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("Include /usr/local/src/ngx_waf/assets/rules/crs-setup.conf\nInclude /etc/nginx/rules/modsecurity/owasp/*.conf\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"第四步-加载规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第四步-加载规则"}},[t._v("#")]),t._v(" 第四步：加载规则")]),t._v(" "),e("p",[t._v("编辑 nginx 的配置文件。")]),t._v(" "),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("waf_modsecurity")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")]),t._v(" file=/etc/nginx/rules/modsecurity/modsecurity.conf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h2",{attrs:{id:"第五步-优化性能"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第五步-优化性能"}},[t._v("#")]),t._v(" 第五步：优化性能")]),t._v(" "),e("p",[t._v("启用规则后会导致性能大幅度降低，这是因为 ModSecurity 的规则引擎十分复杂，但这也为其带来了强大的功能。")]),t._v(" "),e("p",[t._v("一般来说我们无需对一些静态文件进行检查，因此可以根据这一点来优化性能。")]),t._v(" "),e("p",[t._v("编辑 nginx 的配置文件。")]),t._v(" "),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" ~* \\.(gif|jpg|png|jpeg|webp|bmp|swf)$")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("waf_modsecurity")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" ~* \\.(html|htm|js|css)$")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("waf_modsecurity")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"第六步-重启-nginx"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第六步-重启-nginx"}},[t._v("#")]),t._v(" 第六步：重启 nginx")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("nginx -s stop\nnginx\n")])])]),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("为什么不用 nginx -s reload ？")]),t._v(" "),e("p",[t._v("因为目前 ModSecurity 存在内存泄露的 bug，直接重载 nginx 会导致内存泄露和性能降低。")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://github.com/SpiderLabs/ModSecurity/issues/2552",target:"_blank",rel:"noopener noreferrer"}},[t._v("ngin reload memory leak · Issue #2552 · SpiderLabs/ModSecurity"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/SpiderLabs/ModSecurity/issues/2502",target:"_blank",rel:"noopener noreferrer"}},[t._v("It often leads memory leak on nginx reload · Issue #2502 · SpiderLabs/ModSecurity"),e("OutboundLink")],1)])])]),t._v(" "),e("h2",{attrs:{id:"第七步-测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第七步-测试"}},[t._v("#")]),t._v(" 第七步：测试")]),t._v(" "),e("p",[t._v("此时你应该检查网站的运行情况，确保不会因为误报而导致网站异常。")]),t._v(" "),e("h2",{attrs:{id:"第八步-处理误报"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第八步-处理误报"}},[t._v("#")]),t._v(" 第八步：处理误报")]),t._v(" "),e("p",[t._v("处理误报需要对 ModSecurity 的规则语法有所了解，本文不提供这类信息，你可以访问下面的链接来获取相关信息。")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://www.netnea.com/cms/apache-tutorial-7_including-modsecurity-core-rules/#step_7_handling_false_positives_disabling_individual_rules",target:"_blank",rel:"noopener noreferrer"}},[t._v("Including OWASP ModSecurity Core Rule Set – Welcome to netnea"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual-%28v2.x%29",target:"_blank",rel:"noopener noreferrer"}},[t._v("Reference Manual (v2.x) · SpiderLabs/ModSecurity Wiki"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=r.exports}}]);